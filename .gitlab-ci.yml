image: python:3.13

variables:
  # Use uv for fast Python package management
  UV_CACHE_DIR: ".uv-cache"
  # IPFS Kubo version to install
  KUBO_VERSION: "0.37.0"
  # Rust/Cargo cache
  CARGO_HOME: ".cargo"

stages:
  - test

cache:
  paths:
    - .uv-cache/
    - .cargo/

before_script:
  # Install Rust (required for uv)
  - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  - source .cargo/env
  
  # Install uv via cargo for path consistency
  - cargo install --git https://github.com/astral-sh/uv uv
  
  # Install IPFS (Kubo)
  - wget https://dist.ipfs.tech/kubo/v${KUBO_VERSION}/kubo_v${KUBO_VERSION}_linux-amd64.tar.gz
  - tar -xzf kubo_v${KUBO_VERSION}_linux-amd64.tar.gz
  - cd kubo && ./install.sh && cd ..
  - export PATH=$PATH:/usr/local/bin
  
  # Install Python dependencies
  - uv sync

test:
  stage: test
  script:
    # Make staging script executable (CLI will use this automatically)
    - chmod +x staging_ipfs.sh
    
    # Run the test suite (CLI handles daemon management automatically)
    - uv run python test_pipeline.py
  
  artifacts:
    when: on_failure
    paths:
      - "*.log"
      - ".ipfs_staging/logs/"
    expire_in: 1 week
